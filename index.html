<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mapa Rodalies en tiempo real</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-realtime/2.2.0/leaflet-realtime.min.js"></script>

  <script src="https://unpkg.com/mapbox-gl@2.13.0/dist/mapbox-gl.js"></script> 
  <link href="https://unpkg.com/mapbox-gl@2.13.0/dist/mapbox-gl.css" rel="stylesheet"/>  
  <script src="https://unpkg.com/mapbox-gl-leaflet/leaflet-mapbox-gl.js"></script> 

</script> 

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([41.3869, 2.1701], 10);

      mapboxgl.accessToken = 'PWugjwqGJtkv1gAYBrrC';
      var gl = L.mapboxGL({
          style: 'https://api.maptiler.com/maps/019c75be-77bb-7d27-bca6-c31ad2e6fd16/style.json?key=PWugjwqGJtkv1gAYBrrC',
          attribution: '&copy; MapTiler &copy; OpenStreetMap contributors'

    }).addTo(map);

 // SHAPES (lÃ­neas) con colores de ruta

const routeColors = {}; // route_id -> color

async function cargarShapes() {
  const res = await fetch("./shapes1.json");
  const geojson = await res.json();

  L.geoJSON(geojson, {
    style: feature => {
      const color = feature.properties.route_color || "000000";
      let routeId = feature.properties.route_id  || "";

      const match = routeId.match(/R[L|T]?(\d+)/i);
          if(match) {
            routeId = "R" + match[1];
          } else {
            routeId = routeId.toUpperCase();
          }

          if(routeId && color) {
            routeColors[routeId] = "#" + color;
          };
      console.log("Shape route:", routeId);

      return {
        color: "#" + color,
        weight: 4,
        opacity: 0.8
      };
    }
  }).addTo(map);
}


// TRENES EN TIEMPO REAL

function iniciarTiempoReal() {

  const trenesURL = "/api/trenes";

  const realtimeLayer = L.realtime(
    async (success, error) => {
      try {
        const response = await fetch(trenesURL);
        const data = await response.json();

        //console.log("Trenes:", data.entity?.length);

        const features = (data.entity || [])
          .filter(e => e.vehicle && e.vehicle.position)
          .map(e => {

            const label = e.vehicle.vehicle?.label || "";

            // Extrae "R1" de "R1-25638-PLATF.(2)"
           // const linea = label.split("-")[0].trim().toUpperCase();
            //const color = routeColors[linea] || "#FF0000";

                            const lineaMatch = label.match(/R[L|T]?(\d+)/i);
                const lineaKey = lineaMatch ? "R" + lineaMatch[1] : "R1";

                const color = routeColors[lineaKey] || "#FF0000";

            return {
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [
                  e.vehicle.position.longitude,
                  e.vehicle.position.latitude
                ]
              },
              properties: {
                id: e.id,
                color: color
              }
            };
          });

        success({
          type: "FeatureCollection",
          features
        });

      } catch (err) {
        console.error(err);
        error(err);
      }
    },
    {
      interval: 5000,
      pointToLayer: (feature, latlng) =>
     L.circleMarker(latlng, {
          radius: 4.5,
          color: "#2E2E2E",
          weight: 0.5,
          fillColor: feature.properties.color || "#FF0000",
          fillOpacity: 1,
        })
    }
  ).addTo(map);

  realtimeLayer.bringToFront();
}
cargarShapes().then(() => {
  iniciarTiempoReal();
});

  </script>
</body>
</html>


